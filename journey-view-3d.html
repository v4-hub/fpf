<!DOCTYPE html>
<html lang="zh-CN" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Journey Explorer | 足迹地图</title>
    <link rel="icon" href="assets/images/favicon.ico" type="image/x-icon">

    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;900&display=swap" rel="stylesheet">

    <!-- Globe.gl & Three.js -->
    <script src="https://unpkg.com/three"></script>
    <script src="https://unpkg.com/globe.gl"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #050505;
            color: white;
            font-family: 'Outfit', sans-serif;
        }

        #globeViz {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }

        .overlay-ui {
            position: absolute;
            z-index: 10;
            pointer-events: none;
            /* Let clicks pass through generally */
        }

        .pointer-events-auto {
            pointer-events: auto;
        }

        /* Glassmorphism panel */
        .glass-panel {
            background: rgba(15, 15, 20, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .journey-card {
            top: 2rem;
            left: 2rem;
            width: 380px;
            max-height: 85vh;
            overflow-y: auto;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.5);
            border-radius: 3px;
        }

        .point-item {
            transition: all 0.3s;
            border-left: 2px solid transparent;
        }

        .point-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-left-color: #6366f1;
        }

        .point-item.active {
            background: rgba(99, 102, 241, 0.15);
            border-left-color: #a855f7;
        }

        .play-controls {
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 1rem;
            padding: 1rem 2rem;
            border-radius: 4rem;
        }

        .control-btn {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .control-btn:hover {
            background: rgba(99, 102, 241, 0.6);
            transform: scale(1.1);
        }

        .control-btn.active {
            background: #6366f1;
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.6);
        }
    </style>
</head>

<body>

    <!-- The 3D Canvas -->
    <div id="globeViz"></div>

    <!-- UI Overlay: Journey Selection/Data -->
    <div class="overlay-ui pointer-events-auto journey-card glass-panel p-6 flex flex-col">
        <a href="dashboard.html" class="text-xs text-indigo-400 hover:text-indigo-300 mb-4 flex items-center gap-1">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>

        <h1 id="jTitle"
            class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-purple-400 mb-2">
            Loading...</h1>
        <p id="jDesc" class="text-sm text-gray-400 font-light mb-6">Fetching journey data from the stars...</p>

        <div class="flex items-center gap-4 mb-6 text-xs text-gray-500 border-b border-white/10 pb-4">
            <span><i class="fas fa-eye"></i> <span id="jViews">0</span></span>
            <span><i class="fas fa-map-marker-alt"></i> <span id="jPointsCount">0</span> stops</span>
        </div>

        <div class="flex-1 overflow-y-auto pr-2" id="pointsList">
            <!-- Points will be injected here -->
        </div>
    </div>

    <!-- UI Overlay: Player Controls -->
    <div class="overlay-ui pointer-events-auto play-controls glass-panel">
        <button class="control-btn" id="btnPrev" title="Previous Stop"><i class="fas fa-backward"></i></button>
        <button class="control-btn active" id="btnPlay" title="Auto Play"><i class="fas fa-play"></i></button>
        <button class="control-btn" id="btnNext" title="Next Stop"><i class="fas fa-forward"></i></button>
        <button class="control-btn" id="btnAudioToggle" title="Toggle Auto-Audio"><i
                class="fas fa-volume-up"></i></button>
    </div>

    <!-- Audio Element -->
    <audio id="ttsAudio" class="hidden"></audio>

    <script>
        // Data State
        let journeyData = null;
        let points = [];
        let arcs = [];
        let currentIndex = -1;
        let isPlaying = false;
        let autoAudio = true;
        let playInterval;

        // Ensure audio element resets properly
        const audioEl = document.getElementById('ttsAudio');
        audioEl.onended = () => {
            if (isPlaying) {
                // When audio ends, wait 1 sec then go to next
                setTimeout(nextPoint, 1500);
            }
        };

        // Initialize Globe
        const globe = Globe()
            (document.getElementById('globeViz'))
            .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
            .bumpImageUrl('//unpkg.com/three-globe/example/img/earth-topology.png')
            .backgroundImageUrl('//unpkg.com/three-globe/example/img/night-sky.png')
            .showAtmosphere(true)
            .atmosphereColor('#6366f1')
            .atmosphereAltitude(0.25)
            .arcColor(() => '#a855f7')
            .arcDashLength(0.4)
            .arcDashGap(0.2)
            .arcDashAnimateTime(1500)
            .arcStroke(1)
            .pointColor(() => '#ec4899')
            .pointAltitude(0.08)
            .pointRadius(0.5)
            .pointsTransitionDuration(1000);

        // Initial setup
        globe.controls().autoRotate = true;
        globe.controls().autoRotateSpeed = 0.5;

        // Fetch Data
        const urlParams = new URLSearchParams(window.location.search);
        const journeyId = urlParams.get('id') || 1; // Default to 1 for demo purposes

        async function fetchJourney() {
            try {
                // We use relative URL to api to fetch
                const res = await fetch(`/api/journeys/${journeyId}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });

                if (!res.ok) throw new Error("Failed to fetch");
                journeyData = await res.json();

                document.getElementById('jTitle').innerText = journeyData.title;
                document.getElementById('jDesc').innerText = journeyData.description || '';
                document.getElementById('jViews').innerText = journeyData.view_count;
                document.getElementById('jPointsCount').innerText = journeyData.points.length;

                processPoints(journeyData.points);

            } catch (e) {
                console.error(e);
                document.getElementById('jTitle').innerText = "Error Loading Journey";
                document.getElementById('jDesc').innerText = "Could not connect to database or journey not found.";
            }
        }

        function processPoints(rawPoints) {
            // Sort by order_index just in case
            points = rawPoints.sort((a, b) => a.order_index - b.order_index);

            // Render list
            const listDiv = document.getElementById('pointsList');
            listDiv.innerHTML = '';

            points.forEach((p, idx) => {
                const item = document.createElement('div');
                item.className = 'point-item cursor-pointer p-4 mb-2 rounded border border-white/5';
                item.onclick = () => focusPoint(idx, true); // true = user clicked
                item.id = `point-item-${idx}`;

                item.innerHTML = `
                    <div class="text-xs text-indigo-400 font-bold mb-1">${p.time}</div>
                    <div class="text-lg font-bold mb-1">${p.location}</div>
                    <div class="text-sm text-gray-400 line-clamp-2">${p.content}</div>
                `;
                listDiv.appendChild(item);
            });

            // Build arcs
            arcs = [];
            for (let i = 0; i < points.length - 1; i++) {
                arcs.push({
                    startLat: points[i].latitude,
                    startLng: points[i].longitude,
                    endLat: points[i + 1].latitude,
                    endLng: points[i + 1].longitude
                });
            }

            // Update Globe
            globe.pointsData(points.map(p => ({ lat: p.latitude, lng: p.longitude, size: 0.5 })));
            globe.arcsData(arcs);

            // Start visualization
            if (points.length > 0) {
                setTimeout(() => focusPoint(0), 1000);
            }
        }

        async function playTTS(text) {
            if (!autoAudio) return;

            // Assuming we have an audio URL if not we can dynamically generate it
            // For now, let's call the TTS generator if it doesn't exist
            try {
                const res = await fetch('/api/ai/tts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        text: text,
                        filename: `temp_${Date.now()}.mp3`
                    })
                });
                if (res.ok) {
                    const data = await res.json();
                    audioEl.src = '/' + data.audio_url;
                    audioEl.play();
                } else {
                    // if TTS fails, manually skip
                    if (isPlaying) setTimeout(nextPoint, 3000);
                }
            } catch (e) {
                console.error("TTS Error", e);
                if (isPlaying) setTimeout(nextPoint, 3000);
            }
        }

        function focusPoint(idx, userInitiated = false) {
            if (idx < 0 || idx >= points.length) return;

            // handle audio interruption
            audioEl.pause();

            if (userInitiated && isPlaying) {
                togglePlay(); // pause if user clicks manually
            }

            currentIndex = idx;
            const p = points[idx];

            // UI Updates
            document.querySelectorAll('.point-item').forEach(el => el.classList.remove('active'));
            const activeEl = document.getElementById(`point-item-${idx}`);
            if (activeEl) {
                activeEl.classList.add('active');
                activeEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            // Globe Camera Update
            globe.controls().autoRotate = false;
            globe.pointOfView({ lat: p.latitude, lng: p.longitude, altitude: 1.5 }, 1500);

            // Highlight specific arc
            const activeArcs = (idx > 0) ? [arcs[idx - 1]] : [];
            globe.arcsData(arcs).arcColor(d => activeArcs.includes(d) ? '#ec4899' : '#6366f1');

            // Narrate if playing or user-initiated 
            if (isPlaying || userInitiated) {
                // If the point already has an audio_url from the DB, use it directly
                // Wait, createdata sets audio_url to null. We rely on the endpoint to generate it instantly.
                playTTS(`${p.location}。${p.content}`);
            }
        }

        function nextPoint() {
            if (currentIndex < points.length - 1) {
                focusPoint(currentIndex + 1);
            } else {
                togglePlay(); // pause at end
            }
        }

        function prevPoint() {
            if (currentIndex > 0) {
                focusPoint(currentIndex - 1);
            }
        }

        function togglePlay() {
            isPlaying = !isPlaying;
            const btn = document.getElementById('btnPlay');
            if (isPlaying) {
                btn.innerHTML = '<i class="fas fa-pause"></i>';
                btn.classList.add('active');
                if (currentIndex === -1 || (currentIndex === points.length - 1)) {
                    focusPoint(0); // restart from beginning
                } else {
                    focusPoint(currentIndex); // re-trigger audio for current
                }
            } else {
                btn.innerHTML = '<i class="fas fa-play"></i>';
                btn.classList.remove('active');
                audioEl.pause();
            }
        }

        // Event Listeners
        document.getElementById('btnPrev').onclick = () => { focusPoint(Math.max(0, currentIndex - 1), true); };
        document.getElementById('btnNext').onclick = () => { focusPoint(Math.min(points.length - 1, currentIndex + 1), true); };
        document.getElementById('btnPlay').onclick = () => { togglePlay(); };

        const audioBtn = document.getElementById('btnAudioToggle');
        audioBtn.onclick = () => {
            autoAudio = !autoAudio;
            if (autoAudio) {
                audioBtn.classList.add('active');
                audioBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
            } else {
                audioBtn.classList.remove('active');
                audioBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                audioEl.pause();
            }
        };

        // Resize handler
        window.addEventListener('resize', () => {
            globe.width(window.innerWidth).height(window.innerHeight);
        });

        // Bootstrap
        fetchJourney();

    </script>
</body>

</html>